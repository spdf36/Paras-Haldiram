<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, getDoc, runTransaction
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// --------------------------------------------------------------------------
// ✅ FIREBASE CONFIG
// --------------------------------------------------------------------------
const firebaseConfig = {
  apiKey: "AIzaSyB6twWRWqW76Gy0UClFGHarhk8K6TlUFao",
  authDomain: "paras-haldiram.firebaseapp.com",
  projectId: "paras-haldiram",
  storageBucket: "paras-haldiram.firebasestorage.app",
  messagingSenderId: "132881310843",
  appId: "1:132881310843:web:06ad2ec9505676f528aede"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --------------------------------------------------------------------------
// DOM ELEMENTS
// --------------------------------------------------------------------------
const productsTableBody = document.querySelector('#productsTable tbody');
const selectProduct = document.getElementById('selectProduct');
const cartList = document.getElementById('cartList');
const cartTotalEl = document.getElementById('cartTotal');
const lowStockBanner = document.getElementById('lowStockBanner');
const invoiceContent = document.getElementById('invoiceContent');
const invoicePrint = document.getElementById('invoicePrint');
const lastInvoiceArea = document.getElementById('lastInvoiceArea');
const previousBillsArea = document.getElementById('previousBillsArea');
const exportAllCSVBtn = document.getElementById('exportAllCSV');

const p_name = document.getElementById('p_name');
const p_price = document.getElementById('p_price');
const p_stock = document.getElementById('p_stock');
const p_threshold = document.getElementById('p_threshold');

let editingProductId = null;
let cart = [];

function money(n) { return '₹' + Number(n).toFixed(2); }

// --------------------------------------------------------------------------
// ✅ Unique Invoice No. (NEVER repeats even after deleting)
// --------------------------------------------------------------------------
async function generateInvoiceNo() {
  const cRef = doc(db, "meta", "invoiceCounter");

  const newInvoice = await runTransaction(db, async (transaction) => {
    const snap = await transaction.get(cRef);

    let nextNumber = 1;
    if (snap.exists()) {
      nextNumber = (snap.data().value || 0) + 1;
    }

    transaction.set(cRef, { value: nextNumber });
    return nextNumber;
  });

  return "INV" + String(newInvoice).padStart(6, "0");
}

// --------------------------------------------------------------------------
// PRODUCT LOAD/RENDER
// --------------------------------------------------------------------------
async function loadProductsFromFirestore() {
  const snap = await getDocs(collection(db, 'products'));
  const products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  renderProducts(products);
  return products;
}

function renderProducts(products) {
  productsTableBody.innerHTML = '';
  selectProduct.innerHTML = '';

  products.forEach(p => {
    const tr = document.createElement('tr');
    if (p.stock <= (p.threshold || 0)) tr.classList.add('low-stock');

    tr.innerHTML = `
      <td>${p.name}</td>
      <td>${money(p.price)}</td>
      <td>${p.stock}</td>
      <td>${p.threshold || 0}</td>
      <td>
        <button onclick="editProductFire('${p.id}')">Edit</button>
        <button onclick="deleteProductFire('${p.id}')" style="background:#c62828">Del</button>
      </td>
    `;

    productsTableBody.appendChild(tr);

    const o = document.createElement('option');
    o.value = p.id;
    o.textContent = `${p.name} (${p.stock})`;
    selectProduct.appendChild(o);
  });

  const low = products.filter(x => x.stock <= (x.threshold || 0));
  lowStockBanner.innerHTML = low.length ?
    `<span style='color:#c62828'>Low stock: ${low.map(x => x.name + ' (' + x.stock + ')').join(', ')}</span>`
    : 'All products are sufficiently stocked.';
}

// Edit product (global scope)
window.editProductFire = async (id) => {
  const snap = await getDoc(doc(db, 'products', id));
  if (!snap.exists()) return alert("Product not found");

  const p = snap.data();
  p_name.value = p.name;
  p_price.value = p.price;
  p_stock.value = p.stock;
  p_threshold.value = p.threshold || 0;

  editingProductId = id;
  document.getElementById('saveProduct').textContent = "Update";
};

// Delete product
window.deleteProductFire = async (id) => {
  if (!confirm("Delete this product?")) return;
  await deleteDoc(doc(db, 'products', id));
  await loadProductsFromFirestore();
};

// Add / Update product
document.getElementById('productForm').onsubmit = async (e) => {
  e.preventDefault();

  const name = p_name.value;
  const price = parseFloat(p_price.value);
  const stock = parseInt(p_stock.value);
  const threshold = parseInt(p_threshold.value) || 0;

  if (editingProductId) {
    await updateDoc(doc(db, 'products', editingProductId), { name, price, stock, threshold });
    editingProductId = null;
    document.getElementById('saveProduct').textContent = "Add Product";
  } else {
    await addDoc(collection(db, 'products'), { name, price, stock, threshold });
  }

  e.target.reset();
  await loadProductsFromFirestore();
};

// --------------------------------------------------------------------------
// CART
// --------------------------------------------------------------------------
function renderCart() {
  cartList.innerHTML = '';
  let total = 0;

  cart.forEach(c => {
    const amt = c.price * c.qty;
    total += amt;
    const d = document.createElement('div');
    d.className = "cart-item";
    d.innerHTML = `<div>${c.name} × ${c.qty}</div><div>${money(amt)}</div>`;
    cartList.appendChild(d);
  });

  cartTotalEl.textContent = money(total);
}

document.getElementById("addToCart").onclick = async () => {
  const pid = selectProduct.value;
  const qty = parseInt(document.getElementById("cartQty").value) || 1;
  if (!pid) return alert("Select product");

  const snap = await getDoc(doc(db, "products", pid));
  if (!snap.exists()) return alert("Product not found");

  const prod = snap.data();
  if (qty > prod.stock) return alert("Not enough stock");

  const existing = cart.find(c => c.id === pid);
  if (existing) existing.qty += qty;
  else cart.push({ id: pid, name: prod.name, price: prod.price, qty });

  renderCart();
};

document.getElementById("clearCart").onclick = () => { cart = []; renderCart(); };

// --------------------------------------------------------------------------
// GENERATE BILL (USES UNIQUE ID)
// --------------------------------------------------------------------------
async function generateBillFirestore() {
  if (!cart.length) return alert("Cart empty");

  // ✅ Unique permanent invoice number
  const invoiceNo = await generateInvoiceNo();
  const date = new Date().toLocaleString();
  const subtotal = cart.reduce((s, i) => s + (i.price * i.qty), 0);

  const customerName = document.getElementById("customerName").value.trim() || "N/A";
  const address = document.getElementById("address").value.trim() || "N/A";

  const saleDoc = {
    invoiceNo,
    date,
    customerName,
    address,
    items: cart,
    subtotal,
    total: subtotal
  };

  const saleRef = await addDoc(collection(db, "sales"), saleDoc);

  // Reduce stock
  for (const it of cart) {
    const ref = doc(db, "products", it.id);
    const snap = await getDoc(ref);
    if (snap.exists()) {
      const newStock = Math.max(0, (snap.data().stock || 0) - it.qty);
      await updateDoc(ref, { stock: newStock });
    }
  }

  showInvoice(saleDoc, saleRef.id);
  cart = [];
  renderCart();

  await loadProductsFromFirestore();
  await loadPreviousBills();
}

document.getElementById("generateBill").onclick = generateBillFirestore;

// --------------------------------------------------------------------------
// INVOICE DISPLAY
// --------------------------------------------------------------------------
function showInvoice(sale, docId) {
  invoiceContent.innerHTML = `
  <style>
    .memo-container{border:3px solid #d62828;padding:20px;width:680px;font-family:'Segoe UI',sans-serif;color:#d62828;}
    .memo-table{width:100%;border-collapse:collapse;font-size:14px;color:black;}
    .memo-table th,.memo-table td{border:2px solid #d62828;padding:4px;text-align:center;}
    .final-row td{font-weight:bold;text-align:right;padding-right:18px}
  </style>

  <div class="memo-container">
    <h2 style="text-align:center;margin-bottom:5px;">Khodal Enterprise</h2>
    <div style="display:flex;justify-content:space-between;color:black;margin-top:10px;">
      <div>Name: <b>${sale.customerName}</b></div>
      <div>Address: <b>${sale.address}</b></div>
      <div>Bill No.: <b>${sale.invoiceNo}</b></div>
    </div>

    <table class="memo-table">
      <thead><tr><th>No.</th><th>Description</th><th>Qty</th><th>Amount</th></tr></thead>
      <tbody>
        ${sale.items.map((i, idx) => `
          <tr><td>${idx + 1}</td><td>${i.name}</td><td>${i.qty}</td><td>₹ ${(i.qty * i.price).toFixed(2)}</td></tr>
        `).join("")}
        <tr class="final-row"><td colspan="3">Total</td><td>₹ ${sale.total.toFixed(2)}</td></tr>
      </tbody>
    </table>
  </div>`;

  invoicePrint.style.display = "block";
  lastInvoiceArea.textContent = `Invoice ${sale.invoiceNo}`;
  lastInvoiceArea.dataset.docId = docId;
}

// --------------------------------------------------------------------------
// PREVIOUS BILLS UI
// --------------------------------------------------------------------------
async function loadPreviousBills() {
  const snap = await getDocs(collection(db, 'sales'));

  if (snap.empty) return previousBillsArea.textContent = "No bills yet";

  previousBillsArea.innerHTML = "";
  const docs = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.invoiceNo < b.invoiceNo ? 1 : -1);

  const tbl = document.createElement("table");
  tbl.innerHTML = `<thead><tr><th>Invoice ID</th><th>Date</th><th>Total</th><th>Action</th></tr></thead>`;

  const tbody = document.createElement("tbody");

  docs.forEach(d => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.invoiceNo}</td>
      <td>${d.date}</td>
      <td>${money(d.total)}</td>
      <td>
        <button onclick="showInvoice(${JSON.stringify(d)}, '${d.id}')">View</button>
        <button onclick="downloadInvoice('${d.id}')">Download</button>
        <button onclick="deleteBill('${d.id}')" style="background:#c62828">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  tbl.appendChild(tbody);
  previousBillsArea.appendChild(tbl);
}

// Delete bill
window.deleteBill = async (id) => {
  if (!confirm("Delete this bill permanently?")) return;
  await deleteDoc(doc(db, "sales", id));
  loadPreviousBills();
};

// PDF download
window.downloadInvoice = async (id) => {
  const snap = await getDoc(doc(db, "sales", id));
  if (!snap.exists()) return alert("Not found");

  showInvoice(snap.data(), id);
  html2pdf().from(invoiceContent).save(`${snap.data().invoiceNo}.pdf`);
};

// Auto load on page start
loadProductsFromFirestore();
loadPreviousBills();
</script>
