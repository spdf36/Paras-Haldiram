<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Paras Haldiram â€” Inventory & Billing</title>
  <style>
    :root{
      --accent:#d35400; --accent-dark:#a84400;
      --muted:#6b6b6b; --bg:#f8f5ef; --card:#ffffff;
      --success:#2e7d32; --danger:#c62828;
    }
    body{margin:0;font-family:'Segoe UI',Roboto,sans-serif;background:var(--bg);color:#222}
    header{background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:white;padding:15px 20px;display:flex;align-items:center;justify-content:space-between}
    header .brand{font-weight:700;font-size:22px;}
    main{display:grid;grid-template-columns:1fr 380px;gap:18px;padding:20px;max-width:1200px;margin:auto;}
    .card{background:var(--card);border-radius:10px;padding:15px;box-shadow:0 4px 12px rgba(0,0,0,0.05)}
    input,select{padding:8px;border-radius:6px;border:1px solid #ddd;width:100%;font-size:14px;}
    button{background:var(--accent);color:white;border:0;padding:8px 12px;border-radius:6px;cursor:pointer;}
    button:hover{background:var(--accent-dark)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    tr.low-stock{background:#f71119}

    #invoicePrint{background:white;padding:30px;max-width:800px;margin:auto;}
    .invoice-box table{width:100%;border-collapse:collapse;}
    .invoice-box table td{padding:6px;}
    .invoice-box table tr.heading td{background:#eee;font-weight:bold;}
    .invoice-box table tr.total td:nth-child(3){font-weight:bold;border-top:2px solid #eee;}

    @media print{
      body *{visibility:hidden}
      #invoicePrint, #invoicePrint *{visibility:visible}
      #invoicePrint{position:absolute;left:0;top:0;width:100%}
      header,main{display:none !important;}
      @page{margin:15mm}
    }
  </style>
</head>
<body>
<header>
  <div class="brand">Paras Haldiram</div>
  <div>Inventory & Billing Software</div>
</header>

<main>
  <section>
    <div class="card">
      <h3>Add / Edit Product</h3>
      <form id="productForm">
        <input id="p_name" placeholder="Product Name" required><br><br>
        <input id="p_price" type="number" placeholder="Price" required><br><br>
        <input id="p_stock" type="number" placeholder="Stock" required><br><br>
        <input id="p_threshold" type="number" placeholder="Low Stock Alert at (qty)"><br><br>
        <button id="saveProduct">Add Product</button>
      </form>
    </div>

    <div class="card">
      <h3>Product Stock</h3>
      <div id="lowStockBanner" class="muted"></div>
      <table id="productsTable">
        <thead><tr><th>Name</th><th>Price</th><th>Stock</th><th>Threshold</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card" id="previous-bills-section">
      <h3>Previous Generated Bills</h3>
      <button id="exportAllCSV" style="background:#2f80ed;margin-bottom:8px">Export All Bills (CSV)</button>
      <div id="previousBillsArea">Loadingâ€¦</div>
    </div>
  </section>

  <aside>
    <div class="card">
      <h3>Create Bill</h3>
      <select id="selectProduct"></select><br><br>
      <input id="cartQty" type="number" value="1" min="1"><br><br>
      <button id="addToCart">Add to Cart</button>
      <div id="cartList" style="margin-top:10px"></div>
      <h3 style="text-align:right;margin-top:10px">Total: <span id="cartTotal">â‚¹0.00</span></h3>
      <button id="generateBill">Generate Bill</button>
      <button id="clearCart" style="background:#777;margin-left:5px">Clear</button>
    </div>

    <div class="card">
      <h3>Last Invoice</h3>
      <div id="lastInvoiceArea" class="muted">None</div><br>
      <button id="printLast">Print / Download Bill</button>
    </div>
  </aside>
</main>

<!-- Hidden printable invoice container -->
<div id="invoicePrint" style="display:none">
  <div id="invoiceContent" class="invoice-box"></div>
</div>

<!-- html2pdf -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* ðŸ”¥ Firebase Config (Yours) */
const firebaseConfig = {
  apiKey: "AIzaSyB6twWRWqW76Gy0UClFGHarhk8K6TlUFao",
  authDomain: "paras-haldiram.firebaseapp.com",
  projectId: "paras-haldiram",
  storageBucket: "paras-haldiram.firebasestorage.app",
  messagingSenderId: "132881310843",
  appId: "1:132881310843:web:06ad2ec9505676f528aede"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* DOM Refs */
const productsTableBody = document.querySelector('#productsTable tbody');
const selectProduct = document.getElementById('selectProduct');
const cartList = document.getElementById('cartList');
const cartTotalEl = document.getElementById('cartTotal');
const invoicePrint = document.getElementById('invoicePrint');
const invoiceContent = document.getElementById('invoiceContent');
const lastInvoiceArea = document.getElementById('lastInvoiceArea');
const previousBillsArea = document.getElementById('previousBillsArea');
const exportAllCSVBtn = document.getElementById('exportAllCSV');

/* Helpers */
let cart = [];
let editingProductId = null;
const money = n => "â‚¹" + Number(n).toFixed(2);
const invoiceIdNow = () => "INV" + Date.now();

/* ------------------------- PRODUCT CRUD ---------------------------- */
async function loadProducts(){
  const snap = await getDocs(collection(db,"products"));
  const products = snap.docs.map(d => ({id:d.id, ...d.data()}));
  renderProducts(products);
}
function renderProducts(products){
  productsTableBody.innerHTML = "";
  selectProduct.innerHTML = "";
  products.forEach(p=>{
    const tr = document.createElement("tr");
    if(p.stock <= (p.threshold||0)) tr.classList.add("low-stock");
    tr.innerHTML = `
      <td>${p.name}</td><td>${money(p.price)}</td><td>${p.stock}</td><td>${p.threshold||0}</td>
      <td>
        <button onclick="editProduct('${p.id}')">Edit</button>
        <button onclick="deleteProduct('${p.id}')" style="background:#c62828">Delete</button>
      </td>`;
    productsTableBody.appendChild(tr);

    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = `${p.name} (${p.stock})`;
    selectProduct.appendChild(opt);
  });
}

window.editProduct = async (id)=>{
  const d = await getDoc(doc(db,"products",id));
  if(!d.exists()) return;
  const p = d.data();
  p_name.value = p.name;
  p_price.value = p.price;
  p_stock.value = p.stock;
  p_threshold.value = p.threshold||0;
  editingProductId = id;
  saveProduct.textContent="Update";
};
window.deleteProduct = async (id)=>{
  if(!confirm("Delete product?")) return;
  await deleteDoc(doc(db,"products",id));
  loadProducts();
};

productForm.onsubmit = async (e)=>{
  e.preventDefault();
  const data = {
    name:p_name.value.trim(),
    price:Number(p_price.value),
    stock:Number(p_stock.value),
    threshold:Number(p_threshold.value)
  };
  if(editingProductId){
    await updateDoc(doc(db,"products",editingProductId),data);
    editingProductId=null;
    saveProduct.textContent="Add Product";
  } else {
    await addDoc(collection(db,"products"),data);
  }
  productForm.reset();
  loadProducts();
};

/* ----------------------------- CART ------------------------------- */
function renderCart(){
  cartList.innerHTML="";
  let total = 0;
  cart.forEach(c=>{
    const amt = c.price*c.qty;
    total+=amt;
    cartList.innerHTML += `<div>${c.name} Ã— ${c.qty} â€” ${money(amt)}</div>`;
  });
  cartTotalEl.textContent = money(total);
}
addToCart.onclick = async ()=>{
  const pid = selectProduct.value;
  const qty = Number(cartQty.value);
  const snap = await getDoc(doc(db,"products",pid));
  const p = snap.data();
  if(qty > p.stock) return alert("Not enough stock");

  const ex = cart.find(i=>i.id===pid);
  if(ex) ex.qty+=qty;
  else cart.push({id:pid,name:p.name,price:p.price,qty});

  renderCart();
};
clearCart.onclick = ()=>{ cart=[]; renderCart(); };

/* ----------------------------- BILLING ---------------------------- */
function showInvoice(sale, docId){
  invoiceContent.innerHTML = `
    <h2 style="text-align:center;margin-bottom:0">ðŸ”¹ Paras Haldiram ðŸ”¹</h2>
    <p style="text-align:center;margin-top:4px">Customer Copy</p>
    <table>
      <tr><td><strong>Date:</strong> ${sale.date}</td><td><strong>Invoice:</strong> ${sale.invoiceNo}</td></tr>
    </table><br>
    <table>
      <tr class="heading"><td>Item</td><td>Qty</td><td>Amount</td></tr>
      ${sale.items.map(i=>`
        <tr><td>${i.name}</td><td>${i.qty}</td><td>${money(i.price*i.qty)}</td></tr>
      `).join("")}
      <tr class="total"><td></td><td>Total</td><td>${money(sale.total)}</td></tr>
    </table>
    <p style="text-align:center;margin-top:10px;font-size:13px">Thank you for shopping with us!</p>
  `;

  invoicePrint.style.display = "block";
  lastInvoiceArea.innerText = `Invoice ${sale.invoiceNo} â€” ${sale.date}`;
  lastInvoiceArea.dataset.docId = docId;
}

generateBill.onclick = async ()=>{
  if(!cart.length) return alert("Cart empty");
  const invoiceNo = invoiceIdNow();
  const date = new Date().toLocaleString();
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);

  const newBill = { invoiceNo, date, items:[...cart], total };
  const ref = await addDoc(collection(db,"sales"), newBill);

  for(const it of cart){
    const prodRef = doc(db,"products",it.id);
    const prodSnap = await getDoc(prodRef);
    const p = prodSnap.data();
    await updateDoc(prodRef,{ stock:p.stock - it.qty });
  }

  showInvoice(newBill, ref.id);
  cart=[]; renderCart(); loadProducts(); loadPreviousBills();
};

/* Print last invoice */
printLast.onclick = ()=>{
  if(!invoiceContent.innerHTML) return alert("No invoice");
  window.print();
};

/* -------------------------- VIEW / Download ----------------------- */
async function viewBillFromList(id){
  const snap = await getDoc(doc(db,"sales",id));
  if(!snap.exists()) return alert("Bill not found");
  showInvoice(snap.data(), id);
}
async function downloadBillFromList(id){
  await viewBillFromList(id);
  const sale = (await getDoc(doc(db,"sales",id))).data();

  invoicePrint.style.display="block";
  html2pdf().set({
    filename: `${sale.invoiceNo}_CustomerCopy.pdf`,
    html2canvas:{ scale:2 },
    jsPDF:{ unit:"mm", format:"a4" }
  }).from(invoicePrint).save();
}

/* -------------------------- PREVIOUS BILLS ------------------------ */
async function loadPreviousBills(){
  const snap = await getDocs(collection(db,"sales"));
  if(snap.empty){ previousBillsArea.innerHTML="No bills yet"; return; }

  const bills = snap.docs.map(d=>({id:d.id, ...d.data()}));
  bills.sort((a,b)=>b.invoiceNo.localeCompare(a.invoiceNo));

  previousBillsArea.innerHTML = `
    <table><tr><th>Invoice</th><th>Date</th><th>Total</th><th>Action</th></tr>
    ${bills.map(b=>`
      <tr>
        <td>${b.invoiceNo}</td><td>${b.date}</td><td>${money(b.total)}</td>
        <td>
          <button onclick="viewBillFromList('${b.id}')">View</button>
          <button onclick="downloadBillFromList('${b.id}')">Download</button>
          <button style="background:#c62828" onclick="deleteBill('${b.id}')">Delete</button>
        </td>
      </tr>`).join("")}
    </table>`;
}
window.deleteBill = async (id)=>{
  if(!confirm("Delete permanently?")) return;
  await deleteDoc(doc(db,"sales",id));
  loadPreviousBills();
};

/* -------------------------- CSV Export ---------------------------- */
exportAllCSVBtn.onclick = async ()=>{
  const snap = await getDocs(collection(db,"sales"));
  if(snap.empty) return alert("No bills to export");

  const rows = [["InvoiceID","Date","Total","Items"]];
  snap.docs.forEach(d=>{
    const s=d.data();
    rows.push([s.invoiceNo,s.date,s.total,(s.items||[]).map(i=>`${i.name}(${i.qty})`).join("; ")]);
  });

  const csv = rows.map(r=>r.join(",")).join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url;
  a.download="all_bills.csv";
  a.click();
};

/* Init */
loadProducts();
loadPreviousBills();
</script>
</body>
</html>
