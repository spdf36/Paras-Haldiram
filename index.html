<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Paras Haldiram — Inventory & Billing</title>
  <style>
    :root{
      --accent:#d35400;
      --accent-dark:#a84400;
      --muted:#6b6b6b;
      --bg:#f8f5ef;
      --card:#ffffff;
      --success:#2e7d32;
      --danger:#c62828;
    }
    body{margin:0;font-family:'Segoe UI',Roboto,sans-serif;background:var(--bg);color:#222}
    header{background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:white;padding:15px 20px;display:flex;align-items:center;justify-content:space-between}
    header .brand{font-weight:700;font-size:22px;}
    main{display:grid;grid-template-columns:1fr 380px;gap:18px;padding:20px;max-width:1200px;margin:auto;}
    .card{background:var(--card);border-radius:10px;padding:15px;box-shadow:0 4px 12px rgba(0,0,0,0.05)}
    input,select,textarea{padding:8px;border-radius:6px;border:1px solid #ddd;width:100%;font-size:14px;}
    button{background:var(--accent);color:white;border:0;padding:8px 12px;border-radius:6px;cursor:pointer;}
    button:hover{background:var(--accent-dark)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    tr.low-stock{background:#fff4e5}
    .right{text-align:right}
    .muted{color:var(--muted);font-size:13px}
    .cart-item{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #eee}
    .invoice-box{max-width:800px;margin:auto;padding:20px;border:1px solid #eee;box-shadow:0 0 10px rgba(0,0,0,0.15);font-size:16px;line-height:24px;color:#555;background:white}
    .invoice-box table{width:100%;line-height:inherit;text-align:left;border-collapse:collapse;}
    .invoice-box table td{padding:8px;vertical-align:top;}
    .invoice-box table tr.heading td{background:#eee;border-bottom:1px solid #ddd;font-weight:bold;}
    .invoice-box table tr.item td{border-bottom:1px solid #eee;}
    .invoice-box table tr.total td:nth-child(3){border-top:2px solid #eee;font-weight:bold;}
    .invoice-actions{text-align:center;margin-top:10px;}
    .invoice-actions button{margin:0 5px;background:#d35400;color:white;border:0;padding:8px 12px;border-radius:6px;cursor:pointer;}
    .invoice-actions button:hover{background:#a84400;}

    #previous-bills-section{margin-top:40px;}
    #previous-bills-section table{background:#fff;border-collapse:collapse;width:100%;font-size:14px;}
    #previous-bills-section th{background:#f3f3f3;}
    #previous-bills-section td,th{border:1px solid #ddd;padding:8px;}
    #previous-bills-section button{background:#d35400;color:white;border:0;padding:5px 8px;border-radius:4px;cursor:pointer;}
    #previous-bills-section button:hover{background:#a84400;}

    @media print{
      body *{visibility:hidden;}
      #invoicePrint, #invoicePrint *{visibility:visible;}
      #invoicePrint{position:absolute;left:0;top:0;width:100%;}
      header,main{display:none !important;}
      @page { margin: 15mm; size: auto; }
    }
  </style>
</head>
<body>
<header>
  <div class="brand">Paras Haldiram</div>
  <div>Inventory & Billing Software</div>
</header>
<main>
  <section>
    <div class="card">
      <h3>Add / Edit Product</h3>
      <form id="productForm">
        <input id="p_name" placeholder="Product Name" required><br><br>
        <input id="p_price" type="number" placeholder="Price" required><br><br>
        <input id="p_stock" type="number" placeholder="Stock" required><br><br>
        <input id="p_threshold" type="number" placeholder="Low Stock Alert at (qty)"><br><br>
        <button id="saveProduct">Add Product</button>
      </form>
    </div>
    <div class="card">
      <h3>Product Stock</h3>
      <div id="lowStockBanner" class="muted"></div>
      <table id="productsTable">
        <thead><tr><th>Name</th><th>Price</th><th>Stock</th><th>Threshold</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="previous-bills-section" class="card" style="display:none;">
      <h3>Previous Generated Bills</h3>
      <table>
        <thead><tr><th>Invoice ID</th><th>Date</th><th>Total</th><th>Action</th></tr></thead>
        <tbody id="previousBillsBody"></tbody>
      </table>
    </div>
  </section>
  <aside>
    <div class="card">
      <h3>Create Bill</h3>
      <select id="selectProduct"></select><br><br>
      <input id="cartQty" type="number" value="1" min="1"><br><br>
      <button id="addToCart">Add to Cart</button>
      <div id="cartList" style="margin-top:10px"></div>
      <div style="text-align:right;margin-top:10px;font-weight:bold">Total: <span id="cartTotal">₹0.00</span></div>
      <br>
      <button id="generateBill">Generate Bill</button>
      <button id="clearCart" style="background:#777">Clear</button>
    </div>
    <div class="card">
      <h3>Last Invoice</h3>
      <div id="lastInvoiceArea" class="muted">None</div>
      <br>
      <button id="printLast">Print / Download Bill</button>
      <div class="invoice-actions">
        <button id="downloadCustomerCopy">Download Customer Copy</button>
        <button id="printCustomerCopy">Print Customer Copy</button>
      </div>
    </div>
  </aside>
</main>

<div id="invoicePrint" style="display:none">
  <div id="invoiceContent" class="invoice-box"></div>
</div>

<!-- html2pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
const KEY_PRODUCTS='ph_products_v2',KEY_SALES='ph_sales_v2',KEY_BILLS='ph_bills_v1';
let products=[],sales=[],cart=[],editingId=null;
const p_name=document.getElementById('p_name'),p_price=document.getElementById('p_price'),p_stock=document.getElementById('p_stock'),p_threshold=document.getElementById('p_threshold'),productsTableBody=document.querySelector('#productsTable tbody'),selectProduct=document.getElementById('selectProduct'),cartList=document.getElementById('cartList'),cartTotalEl=document.getElementById('cartTotal'),lowStockBanner=document.getElementById('lowStockBanner'),invoiceContent=document.getElementById('invoiceContent'),invoicePrint=document.getElementById('invoicePrint'),lastInvoiceArea=document.getElementById('lastInvoiceArea');

function uid(){return'p'+Date.now()+Math.floor(Math.random()*9999)}
function money(n){return'₹'+Number(n).toFixed(2)}
function save(){localStorage.setItem(KEY_PRODUCTS,JSON.stringify(products));localStorage.setItem(KEY_SALES,JSON.stringify(sales))}
function load(){products=JSON.parse(localStorage.getItem(KEY_PRODUCTS)||'[]');sales=JSON.parse(localStorage.getItem(KEY_SALES)||'[]')}
function refreshProductsTable(){
  productsTableBody.innerHTML='';
  products.forEach(p=>{
    const tr=document.createElement('tr');
    if(p.stock<= (p.threshold||0))tr.classList.add('low-stock');
    tr.innerHTML=`<td>${p.name}</td><td>${money(p.price)}</td><td>${p.stock}</td><td>${p.threshold||0}</td><td><button onclick="editProduct('${p.id}')">Edit</button> <button onclick="deleteProduct('${p.id}')" style="background:#c62828">Del</button></td>`;
    productsTableBody.appendChild(tr)
  });
  selectProduct.innerHTML='';
  products.forEach(p=>{
    const o=document.createElement('option');
    o.value=p.id;
    o.textContent=`${p.name} (${p.stock})`;
    selectProduct.appendChild(o)
  });
  const low=products.filter(x=>x.stock<=(x.threshold||0));
  lowStockBanner.innerHTML=low.length?`<span style='color:#c62828'>Low stock: ${low.map(x=>x.name+' ('+x.stock+')').join(', ')}</span>`:'All products are sufficiently stocked.'
}

function editProduct(id){
  const p=products.find(x=>x.id===id);
  if(!p)return;
  p_name.value=p.name;p_price.value=p.price;p_stock.value=p.stock;p_threshold.value=p.threshold;
  editingId=id;
  document.getElementById('saveProduct').textContent='Update'
}

function deleteProduct(id){
  if(!confirm('Delete this product?'))return;
  products=products.filter(x=>x.id!==id);
  save();refreshProductsTable()
}

document.getElementById('productForm').onsubmit=e=>{
  e.preventDefault();
  const n=p_name.value.trim(),pr=parseFloat(p_price.value),st=parseInt(p_stock.value),th=parseInt(p_threshold.value)||0;
  if(!n)return;
  if(editingId){
    Object.assign(products.find(x=>x.id===editingId),{name:n,price:pr,stock:st,threshold:th});
    editingId=null;document.getElementById('saveProduct').textContent='Add Product'
  }else products.push({id:uid(),name:n,price:pr,stock:st,threshold:th});
  save();refreshProductsTable();e.target.reset()
};

function renderCart(){
  cartList.innerHTML='';
  let total=0;
  cart.forEach(c=>{
    const p=products.find(x=>x.id===c.id);if(!p)return;
    const amt=p.price*c.qty;total+=amt;
    const d=document.createElement('div');
    d.className='cart-item';
    d.innerHTML=`<div>${p.name} × ${c.qty}</div><div>${money(amt)}</div>`;
    cartList.appendChild(d)
  });
  cartTotalEl.textContent=money(total)
}

document.getElementById('addToCart').onclick=()=>{
  const pid=selectProduct.value,qty=parseInt(document.getElementById('cartQty').value)||1;
  const p=products.find(x=>x.id===pid);
  if(!p)return alert('No product');
  if(qty>p.stock)return alert('Not enough stock');
  const ex=cart.find(c=>c.id===pid);
  if(ex)ex.qty+=qty;else cart.push({id:pid,qty});
  renderCart()
}
document.getElementById('clearCart').onclick=()=>{cart=[];renderCart()}

document.getElementById('generateBill').onclick=()=>{
  if(!cart.length)return alert('Cart empty');
  for(const c of cart){
    const p=products.find(x=>x.id===c.id);
    if(!p||p.stock<c.qty)return alert('Insufficient stock')
  }
  const invoiceNo='INV'+Date.now();
  const date=new Date().toLocaleString();
  let sub=0;
  const items=cart.map(c=>{
    const p=products.find(x=>x.id===c.id);
    const amt=p.price*c.qty;sub+=amt;
    return{name:p.name,price:p.price,qty:c.qty,amt}
  });
  items.forEach(it=>{
    const p=products.find(x=>x.name===it.name);p.stock-=it.qty
  });
  const sale={invoiceNo,date,items,subtotal:sub,total:sub};
  sales.push(sale);save();refreshProductsTable();cart=[];renderCart();showInvoice(sale)
}

function showInvoice(sale){
  invoiceContent.innerHTML=`<h2>Paras Haldiram</h2><table><tr><td>Shop Bill<br>Date: ${sale.date}<br>Invoice: ${sale.invoiceNo}</td><td style='text-align:right'>Customer Copy</td></tr></table><br><table><tr class='heading'><td>Item</td><td>Qty</td><td>Amount</td></tr>${sale.items.map(it=>`<tr class='item'><td>${it.name}</td><td>${it.qty}</td><td>${money(it.amt)}</td></tr>`).join('')}<tr class='total'><td></td><td>Total</td><td>${money(sale.total)}</td></tr></table><br><div style='text-align:center;font-size:14px'>Thank you for shopping with Paras Haldiram!</div>`;
  invoicePrint.style.display='block';
  lastInvoiceArea.innerHTML=`Invoice ${sale.invoiceNo} — ${sale.date}`;
  saveBillRecord(sale.invoiceNo, sale.date, sale.total, invoiceContent.innerHTML);
}

document.getElementById('printLast').onclick=()=>{
  if(!invoiceContent.innerHTML)return alert('No invoice');
  window.print()
}

document.getElementById('downloadCustomerCopy').onclick=()=>{
  if(!invoiceContent.innerHTML)return alert('No invoice to download');
  const last=sales[sales.length-1];
  const opt={
    margin:10,
    filename:last?`${last.invoiceNo}.pdf`:'Customer_Copy.pdf',
    image:{type:'jpeg',quality:0.98},
    html2canvas:{scale:2},
    jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
  };
  html2pdf().set(opt).from(invoiceContent).save();
}

document.getElementById('printCustomerCopy').onclick=()=>{
  if(!invoiceContent.innerHTML)return alert('No invoice to print');
  const win=window.open('', '_blank','width=800,height=600');
  win.document.write(`<html><head><title>Customer Copy</title></head><body>${invoiceContent.innerHTML}</body></html>`);
  win.document.close();
  win.print();
}

// ---- Previous Bills Logic ----
function saveBillRecord(invoiceId,date,total,billHTML){
  let bills=JSON.parse(localStorage.getItem(KEY_BILLS)||'[]');
  bills.push({invoiceId,date,total,billHTML});
  localStorage.setItem(KEY_BILLS,JSON.stringify(bills));
  loadPreviousBills();
}

function loadPreviousBills(){
  const tbody=document.getElementById("previousBillsBody");
  const section=document.getElementById("previous-bills-section");
  let bills=JSON.parse(localStorage.getItem(KEY_BILLS)||'[]');
  tbody.innerHTML='';
  if(!bills.length){section.style.display='none';return;}
  section.style.display='block';
  bills.forEach(b=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${b.invoiceId}</td><td>${b.date}</td><td>${money(b.total)}</td><td><button onclick="viewBill('${b.invoiceId}')">View</button> <button onclick="downloadBill('${b.invoiceId}')">Download</button></td>`;
    tbody.appendChild(tr);
  });
}

function viewBill(id){
  let bills=JSON.parse(localStorage.getItem(KEY_BILLS)||'[]');
  const b=bills.find(x=>x.invoiceId===id);
  if(b){
    const win=window.open('', '_blank','width=800,height=600');
    win.document.write(`<html><head><title>${b.invoiceId}</title></head><body>${b.billHTML}</body></html>`);
    win.document.close();
  }
}

function downloadBill(id){
  let bills=JSON.parse(localStorage.getItem(KEY_BILLS)||'[]');
  const b=bills.find(x=>x.invoiceId===id);
  if(b){
    const opt={margin:10,filename:`${b.invoiceId}.pdf`,image:{type:'jpeg',quality:0.98},html2canvas:{scale:2},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}};
    html2pdf().set(opt).from(b.billHTML).save();
  }
}

function init(){load();refreshProductsTable();renderCart();loadPreviousBills();}
init();
</script>
</body>
</html>
